



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://autogoal.github.io/api/autogoal.kb._semantics/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../autogoal-logo-embedded.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.6.3">
    
    
      
        <title>Autogoal.kb. semantics - AutoGOAL</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-172957751-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://autogoal.github.io" title="AutoGOAL" aria-label="AutoGOAL" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../autogoal-logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              AutoGOAL
            </span>
            <span class="md-header-nav__topic">
              
                Autogoal.kb. semantics
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/autogoal/autogoal/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link md-tabs__link--active">
        Home
      </a>
    
  </li>

      
        
      
        
      
        
      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../guide/" class="md-tabs__link">
          User Guide
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../examples/" class="md-tabs__link">
          Examples
        </a>
      
    </li>
  

      
        
      
        
      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../autogoal.__init__/" class="md-tabs__link">
          API
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://autogoal.github.io" title="AutoGOAL" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../autogoal-logo.svg" width="48" height="48">
      
    </a>
    AutoGOAL
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/autogoal/autogoal/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../cli/" title="CLI" class="md-nav__link">
      CLI
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../dependencies/" title="Dependencies" class="md-nav__link">
      Dependencies
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/" title="First steps" class="md-nav__link">
      First steps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.predefined/" title="Predefined pipelines" class="md-nav__link">
      Predefined pipelines
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.include_algorithm/" title="Using custom algorithms" class="md-nav__link">
      Using custom algorithms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.cfg/" title="Class-based API" class="md-nav__link">
      Class-based API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.graph/" title="Graph-based API" class="md-nav__link">
      Graph-based API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.functional/" title="Functional API" class="md-nav__link">
      Functional API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      General-purpose AutoML
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        General-purpose AutoML
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.solving_uci_datasets/" title="Solving UCI datasets" class="md-nav__link">
      Solving UCI datasets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.solving_haha_2019/" title="Solving HAHA 2019" class="md-nav__link">
      Solving HAHA 2019
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.solving_meddocan_2019/" title="Solving MEDDOCAN 2019" class="md-nav__link">
      Solving MEDDOCAN 2019
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3" type="checkbox" id="nav-7-3">
    
    <label class="md-nav__link" for="nav-7-3">
      Using Neural Networks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-3">
        Using Neural Networks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.nn_cars/" title="Solving CARS with Keras" class="md-nav__link">
      Solving CARS with Keras
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.nn_meddocan/" title="Solving MEDDOCAN with Keras" class="md-nav__link">
      Solving MEDDOCAN with Keras
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://autogoal.github.io/demo" title="Demo" class="md-nav__link">
      Demo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://autogoal.github.io/dashboard" title="Dashboard" class="md-nav__link">
      Dashboard
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-1" type="checkbox" id="nav-10-1">
    
    <label class="md-nav__link" for="nav-10-1">
      Top level
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-1">
        Top level
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.__init__/" title="autogoal" class="md-nav__link">
      autogoal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.__main__/" title="cli" class="md-nav__link">
      cli
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-2" type="checkbox" id="nav-10-2">
    
    <label class="md-nav__link" for="nav-10-2">
      Grammars
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-2">
        Grammars
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.grammar.__init__/" title="autogoal.grammar" class="md-nav__link">
      autogoal.grammar
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-3" type="checkbox" id="nav-10-3">
    
    <label class="md-nav__link" for="nav-10-3">
      Contrib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-3">
        Contrib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.contrib.__init__/" title="autogoal.contrib" class="md-nav__link">
      autogoal.contrib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-3-2" type="checkbox" id="nav-10-3-2">
    
    <label class="md-nav__link" for="nav-10-3-2">
      scikit-learn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-10-3-2">
        scikit-learn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.contrib.sklearn.__init__/" title="autogoal.contrib.sklearn" class="md-nav__link">
      autogoal.contrib.sklearn
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/autogoal/autogoal/edit/main/docs/api/autogoal.kb._semantics.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Autogoal.kb. semantics</h1>
                
                <div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""Defines the semantic types hierarchy and utilities to infer types and work with them.</p>
</div>
<p>The AutoML features in AutoGOAL rest in the ability of automatically discovering pipelines
of algorithms that are semantically annotated w.r.t. their inputs and outputs.
This module defines the semantic types hierarchy.</p>
<p>A semantic type is basically a class that provides a meaningful
definition for a value in the problem domain. For example, a list of strings can either
be a list of sentences, words, DNA sequences, or full-fledged documents. Depending on the
interpretation of that value, we want AutoGOAL to select different algorithms, i.e., it makes
no sense to tokenize words, while it is almost mandatory to do so when you have natural language text.</p>
<p>We will never really instantiate these classes, just use them for annotations.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">copyreg</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</code></pre></div>

<p>We start by defining the base class of our hierarchy.
A <code>SemanticType</code> is just a class that knows how to do one thing: determine if a given object
matches its semantic definition.
We will define a metaclass to allow for <code>isinstance</code> and <code>issubclass</code> to work based on our semantic match definition,
and to leave space for implementing class-level <code>__getitem__</code> to allow for a generics kind-of notation.</p>
<p><a name="ref:SemanticTypeMeta"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SemanticTypeMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__instancecheck__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_specialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_specialize</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__subclasscheck__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">subclass</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subclass</span><span class="p">,</span> <span class="s2">&quot;_conforms&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">subclass</span><span class="o">.</span><span class="n">_conforms</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__subclasscheck__</span><span class="p">(</span><span class="n">subclass</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot instantiate a semantic type&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">()</span>
</code></pre></div>

<p><code>SemanticType</code> defines a <code>match</code> method that implements our <code>isinstance</code> method.</p>
<p><a name="ref:SemanticType"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SemanticType</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">SemanticTypeMeta</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_conforms</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> cannot be specialized&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_reduce</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</code></pre></div>

<p>By default, we return the repr name of the class that
allows to serialize globally defined classes.</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">infer</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""Automatically determines the semantic type of a given value.</p>
<blockquote>
<blockquote>
<blockquote>
<p>SemanticType.infer("word")
Word
SemanticType.infer("hello world")
Sentence
SemanticType.infer("Hello world. This a two sentence Document.")
Document</p>
</blockquote>
</blockquote>
</blockquote>
<p>It works with some tensorial types as well.</p>
<blockquote>
<blockquote>
<blockquote>
<p>import numpy as np
SemanticType.infer(np.ones(shape=(2,2)))
Tensor[2, Continuous, Dense]</p>
</blockquote>
</blockquote>
</blockquote>
</div>
<div class="codehilite"><pre><span></span><code>        <span class="n">types</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">SemanticType</span><span class="p">),</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">)</span>
        <span class="n">best_type</span> <span class="o">=</span> <span class="n">SemanticType</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">best_type</span><span class="p">):</span>
                <span class="n">best_type</span> <span class="o">=</span> <span class="n">t</span>

        <span class="k">if</span> <span class="n">best_type</span> <span class="o">==</span> <span class="n">SemanticType</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot infer semantic type for </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_type</span>
</code></pre></div>

<p>To be able to serialize these types, we have to register a reduce function for <code>SemanticTypeMeta</code>.
This reduce function will just dispatch to the proper instance method</p>
<p><a name="ref:_reduce_semantic_type"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">_reduce_semantic_type</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">_reduce</span><span class="p">()</span>


<span class="n">copyreg</span><span class="o">.</span><span class="n">pickle</span><span class="p">(</span><span class="n">SemanticTypeMeta</span><span class="p">,</span> <span class="n">_reduce_semantic_type</span><span class="p">)</span>
</code></pre></div>

<p>Let's start with the natural language hierarchy.</p>
<p><a name="ref:Text"></a>
<a name="ref:Document"></a>
<a name="ref:Sentence"></a>
<a name="ref:Word"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Text</span><span class="p">(</span><span class="n">SemanticType</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Document</span><span class="p">(</span><span class="n">Text</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Sentence</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">Word</span><span class="p">(</span><span class="n">Sentence</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot; &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span>
</code></pre></div>

<p>We also need some basic types for generic kinds of labels, used in NLP, for example.
Keep in mind these do not implement <code>_match</code> as there is no sensible structural way to define them.
They are used solely to annotate algorithms.</p>
<p><a name="ref:Label"></a>
<a name="ref:Postag"></a>
<a name="ref:Chunktag"></a>
<a name="ref:Stem"></a>
<a name="ref:Synset"></a>
<a name="ref:Sentiment"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Label</span><span class="p">(</span><span class="n">SemanticType</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Postag</span><span class="p">(</span><span class="n">Label</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Chunktag</span><span class="p">(</span><span class="n">Label</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Stem</span><span class="p">(</span><span class="n">Text</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Synset</span><span class="p">(</span><span class="n">SemanticType</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Sentiment</span><span class="p">(</span><span class="n">Label</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<p>Another basic type is a feature set, which for us is basically a dictionary of strings vs anything:</p>
<p><a name="ref:FeatureSet"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureSet</span><span class="p">(</span><span class="n">SemanticType</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</code></pre></div>

<p>TODO: This is a very naive implementation of <code>match</code>.</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">)</span>
</code></pre></div>

<p>A first complex type we can implement is <code>Seq</code>, to represent a list (or sequence) of another semantic type.
We want this type to be able to specialize in this notation:</p>
<blockquote>
<blockquote>
<blockquote>
<p>Seq[Word]</p>
</blockquote>
</blockquote>
</blockquote>
<p>For this we have to implement <code>_specialize</code> and synthethize a new type with the corresponding
semantic type that does the match internally.
The challenge here is that we want to return the same <code>Seq</code> type every time we specialize on the same internal type,
so we'll keep a class-level dictionary to store these classes as they are synthethized.</p>
<p>Finally, we want <code>Seq[Word]`` to be a subclass of</code>Seq[Sentence]<code>, or more generally,</code>Seq[X]<code>to be a subclass
of</code>Seq[Y]<code>whenever</code>X &lt; Y`.</p>
<p><a name="ref:Seq"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Seq</span><span class="p">(</span><span class="n">SemanticType</span><span class="p">):</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""Represents a sequence that can be specialized in concrete internal semantic types.</p>
<blockquote>
<blockquote>
<blockquote>
<p>isinstance(["hello", "world"], Seq[Word])
True</p>
</blockquote>
</blockquote>
</blockquote>
<p>Specialized classes are exactly the same, by identity:</p>
<blockquote>
<blockquote>
<blockquote>
<p>id(Seq[Word]) == id(Seq[Word])
True</p>
</blockquote>
</blockquote>
</blockquote>
<p>Specialized classes are subclasses of the raw <code>Seq</code> class:</p>
<blockquote>
<blockquote>
<blockquote>
<p>issubclass(Seq[Word], Seq)
True</p>
</blockquote>
</blockquote>
</blockquote>
<p>And they are subclasses of other specialized classes when the internal types hold the same relationship.</p>
<blockquote>
<blockquote>
<blockquote>
<p>issubclass(Seq[Word], Seq[Text])
True
issubclass(Seq[Text], Seq[Word])
False</p>
</blockquote>
</blockquote>
</blockquote>
<p>They are pretty-printed as well</p>
<blockquote>
<blockquote>
<blockquote>
<p>Seq
Seq
Seq[Word]
Seq[Word]</p>
</blockquote>
</blockquote>
</blockquote>
<p>Subclasses are also serializable (which requires some non-trivial dark magic on the implementation side):</p>
<blockquote>
<blockquote>
<blockquote>
<p>from pickle import dumps, loads
loads(dumps(Seq[Word]))
Seq[Word]</p>
</blockquote>
</blockquote>
</blockquote>
</div>
<div class="codehilite"><pre><span></span><code>    <span class="n">__internal_types</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">internal_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">SemanticType</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Seq</span><span class="o">.</span><span class="n">__internal_types</span><span class="p">[</span><span class="n">internal_type</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">class</span> <span class="nc">SeqImp</span><span class="p">(</span><span class="n">Seq</span><span class="p">):</span>
            <span class="n">__internal_type__</span> <span class="o">=</span> <span class="n">internal_type</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Seq[</span><span class="si">{</span><span class="n">internal_type</span><span class="si">}</span><span class="s2">]&quot;</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="n">internal_type</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_conforms</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Seq</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="n">Seq</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__internal_type__</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">__internal_type__</span><span class="p">)</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_specialize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot specialize more a `Seq` type.&quot;</span><span class="p">)</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_reduce</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Seq</span><span class="o">.</span><span class="n">_specialize</span><span class="p">,</span> <span class="p">(</span><span class="n">internal_type</span><span class="p">,)</span>

        <span class="n">Seq</span><span class="o">.</span><span class="n">__internal_types</span><span class="p">[</span><span class="n">internal_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">SeqImp</span>

        <span class="k">return</span> <span class="n">SeqImp</span>
</code></pre></div>

<p>Now let's move to the algebraic types, vectors, matrices, and tensors.
These wrap numpy arrays of different dimensionalities
We'll have three different semantic labels for each tensor: dimensionality (an integer),
internal type, and a dense/sparse flag.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.base</span> <span class="kn">import</span> <span class="n">spmatrix</span>
</code></pre></div>

<p>These instances represent the two types of tensorial structure.</p>
<p><a name="ref:TensorStructure"></a>
<a name="ref:TensorData"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TensorStructure</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_class</span> <span class="o">=</span> <span class="n">base_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">TensorStructure</span><span class="p">)</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="n">Dense</span> <span class="o">=</span> <span class="n">TensorStructure</span><span class="p">(</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;Dense&quot;</span><span class="p">)</span>
<span class="n">Sparse</span> <span class="o">=</span> <span class="n">TensorStructure</span><span class="p">(</span><span class="n">spmatrix</span><span class="p">,</span> <span class="s2">&quot;Sparse&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TensorData</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype_label</span> <span class="o">=</span> <span class="n">dtype_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype_label</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">TensorData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="n">Categorical</span> <span class="o">=</span> <span class="n">TensorData</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;Categorical&quot;</span><span class="p">)</span>
<span class="n">Continuous</span> <span class="o">=</span> <span class="n">TensorData</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;Continuous&quot;</span><span class="p">)</span>
<span class="n">Discrete</span> <span class="o">=</span> <span class="n">TensorData</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;Discrete&quot;</span><span class="p">)</span>
</code></pre></div>

<p>We want the abstract <code>Tensor</code> type to be specializable using the notation:
<code>Tensor[3, Category, Dense]</code>.
This requires us to implement the <code>_specialize</code> just like we did with <code>Seq</code>.
The internal class will in turn implement <code>_match</code> accordingly to how those values are defined.</p>
<p>One special thing we want to do is to let some of these semantic flags undefined (using <code>None</code>)
such that <code>Tensor[2, None, Dense]</code> represents any structure that can have two dimensions no matter the internal type.
And we want <code>issubclass(...)</code> to work in a way that <code>Tensor[2, Categorical, Dense]</code> is a subclass to <code>Tensor[2, None, Dense]</code>.
For this purpose we will redefine <code>_conforms</code> to match according to how those semantic flags are defined.</p>
<p><a name="ref:Tensor"></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Tensor</span><span class="p">(</span><span class="n">SemanticType</span><span class="p">):</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""Represents an abstract tensor type. Can be specialized into more concrete types.</p>
<p>They support type inference from numpy:</p>
<blockquote>
<blockquote>
<blockquote>
<p>import numpy as np
a_matrix = np.ones(shape=(2,2))
isinstance(a_matrix, Tensor)
True
isinstance(a_matrix, Tensor[1, None, None])
False
isinstance(a_matrix, Tensor[2, None, None])
True
isinstance(a_matrix, Tensor[2, Continuous, Dense])
True
isinstance(a_matrix, Tensor[2, Continuous, Sparse])
False</p>
</blockquote>
</blockquote>
</blockquote>
<p>Tensor types also respect a special definition of subclass in which more specialized
classes are defined as subclasses of less specialized counterparts.</p>
<blockquote>
<blockquote>
<blockquote>
<p>issubclass(Tensor[2, Continuous, Sparse], Tensor[2, None, None])
True
issubclass(Tensor[2, Continuous, Sparse], Tensor[2, Continuous, None])
True
issubclass(Tensor[2, Continuous, Sparse], Tensor[2, None, Dense])
False
issubclass(Tensor[2, Continuous, Sparse], Tensor[3, None, None])
False</p>
</blockquote>
</blockquote>
</blockquote>
<p>Each specific specialization is a singleton class:</p>
<blockquote>
<blockquote>
<blockquote>
<p>id(Tensor[2, Continuous, Dense]) == id(Tensor[2, Continuous, Dense])
True</p>
</blockquote>
</blockquote>
</blockquote>
<p>Tensor types are also serializable:</p>
<blockquote>
<blockquote>
<blockquote>
<p>from pickle import loads, dumps
loads(dumps(Tensor[2, Continuous, Dense]))
Tensor[2, Continuous, Dense]</p>
</blockquote>
</blockquote>
</blockquote>
</div>
<div class="codehilite"><pre><span></span><code>    <span class="n">__internal_types</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">spmatrix</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">internal_type</span><span class="p">:</span> <span class="n">TensorData</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">TensorStructure</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Tensor</span><span class="o">.</span><span class="n">__internal_types</span><span class="p">[(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">internal_type</span><span class="p">,</span> <span class="n">structure</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">class</span> <span class="nc">TensorImp</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">__flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">internal_type</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Tensor[</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">__flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">__flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">__flags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">dimension</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dimension</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">internal_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">internal_type</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">structure</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">return</span> <span class="kc">True</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_conforms</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="n">Tensor</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;_TensorImp__flags&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">fmine</span><span class="p">,</span> <span class="n">fother</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__flags</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">__flags</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fother</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">fmine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">fmine</span> <span class="o">!=</span> <span class="n">fother</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="k">return</span> <span class="kc">True</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_reduce</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</code></pre></div>

<p>To reduce Tensor implementations for pickling</p>
<div class="codehilite"><pre><span></span><code>                <span class="k">return</span> <span class="n">Tensor</span><span class="o">.</span><span class="n">_specialize</span><span class="p">,</span> <span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">internal_type</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>

        <span class="n">Tensor</span><span class="o">.</span><span class="n">__internal_types</span><span class="p">[(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">internal_type</span><span class="p">,</span> <span class="n">structure</span><span class="p">)]</span> <span class="o">=</span> <span class="n">TensorImp</span>

        <span class="k">return</span> <span class="n">TensorImp</span>
</code></pre></div>

<p>Now that we have the basic tensorial type implemented, we can add some aliases here.
These aliases mostly serve for <code>SemanticType.infer</code> to work, and also to simplify imports,
but keep in mind that anywhere we use <code>Vector</code> we just as well use <code>Tensor[1, None, None]</code>,
as they are <em>exactly</em> the same class.</p>
<div class="codehilite"><pre><span></span><code><span class="n">Vector</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">VectorContinuous</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Continuous</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">VectorCategorical</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Categorical</span><span class="p">,</span> <span class="n">Dense</span><span class="p">]</span>
<span class="n">VectorDiscrete</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Discrete</span><span class="p">,</span> <span class="n">Dense</span><span class="p">]</span>

<span class="n">Matrix</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">MatrixContinuous</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Continuous</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">MatrixContinuousDense</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Continuous</span><span class="p">,</span> <span class="n">Dense</span><span class="p">]</span>
<span class="n">MatrixContinuousSparse</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Continuous</span><span class="p">,</span> <span class="n">Sparse</span><span class="p">]</span>
<span class="n">MatrixCategorical</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Categorical</span><span class="p">,</span> <span class="n">Dense</span><span class="p">]</span>
<span class="n">MatrixDiscrete</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Discrete</span><span class="p">,</span> <span class="n">Dense</span><span class="p">]</span>
</code></pre></div>

<p>📝 Makes no sense to have sparse discrete or categorical tensors as you cannot have missing categories.</p>
<div class="codehilite"><pre><span></span><code><span class="n">Tensor3</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">Continuous</span><span class="p">,</span> <span class="n">Dense</span><span class="p">]</span>
<span class="n">Tensor4</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">Continuous</span><span class="p">,</span> <span class="n">Dense</span><span class="p">]</span>
</code></pre></div>

<p>Finally we define the publicly export classes</p>
<div class="codehilite"><pre><span></span><code><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;SemanticType&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Seq&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Text&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Document&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sentence&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Word&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Label&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Postag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Chunktag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Stem&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Synset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sentiment&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FeatureSet&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tensor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Vector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VectorContinuous&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VectorCategorical&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VectorDiscrete&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Matrix&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MatrixContinuous&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MatrixContinuousDense&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MatrixContinuousSparse&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MatrixCategorical&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MatrixDiscrete&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tensor3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tensor4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Dense&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sparse&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Categorical&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Discrete&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../.."}})</script>
      
    
  </body>
</html>