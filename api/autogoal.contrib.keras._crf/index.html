



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://autogoal.github.io/api/autogoal.contrib.keras._crf/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../autogoal-logo-embedded.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.6.3">
    
    
      
        <title>Autogoal.contrib.keras. crf - AutoGOAL</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-172957751-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#orginal-implementation-from-keras_contriblayerscrf" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://autogoal.github.io" title="AutoGOAL" aria-label="AutoGOAL" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../autogoal-logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              AutoGOAL
            </span>
            <span class="md-header-nav__topic">
              
                Autogoal.contrib.keras. crf
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/autogoal/autogoal/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link md-tabs__link--active">
        Home
      </a>
    
  </li>

      
        
      
        
      
        
      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../guide/" class="md-tabs__link">
          User Guide
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../examples/" class="md-tabs__link">
          Examples
        </a>
      
    </li>
  

      
        
      
        
      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../autogoal.__init__/" class="md-tabs__link">
          API
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://autogoal.github.io" title="AutoGOAL" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../autogoal-logo.svg" width="48" height="48">
      
    </a>
    AutoGOAL
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/autogoal/autogoal/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../cli/" title="CLI" class="md-nav__link">
      CLI
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../dependencies/" title="Dependencies" class="md-nav__link">
      Dependencies
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/" title="First steps" class="md-nav__link">
      First steps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.predefined/" title="Predefined pipelines" class="md-nav__link">
      Predefined pipelines
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.include_algorithm/" title="Using custom algorithms" class="md-nav__link">
      Using custom algorithms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.cfg/" title="Class-based API" class="md-nav__link">
      Class-based API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.graph/" title="Graph-based API" class="md-nav__link">
      Graph-based API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/tests.guide.functional/" title="Functional API" class="md-nav__link">
      Functional API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      General-purpose AutoML
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        General-purpose AutoML
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.solving_uci_datasets/" title="Solving UCI datasets" class="md-nav__link">
      Solving UCI datasets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.solving_haha_2019/" title="Solving HAHA 2019" class="md-nav__link">
      Solving HAHA 2019
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.solving_meddocan_2019/" title="Solving MEDDOCAN 2019" class="md-nav__link">
      Solving MEDDOCAN 2019
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3" type="checkbox" id="nav-7-3">
    
    <label class="md-nav__link" for="nav-7-3">
      Using Neural Networks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-3">
        Using Neural Networks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.nn_cars/" title="Solving CARS with Keras" class="md-nav__link">
      Solving CARS with Keras
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../examples/tests.examples.nn_meddocan/" title="Solving MEDDOCAN with Keras" class="md-nav__link">
      Solving MEDDOCAN with Keras
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://autogoal.github.io/demo" title="Demo" class="md-nav__link">
      Demo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://autogoal.github.io/dashboard" title="Dashboard" class="md-nav__link">
      Dashboard
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-1" type="checkbox" id="nav-10-1">
    
    <label class="md-nav__link" for="nav-10-1">
      Top level
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-1">
        Top level
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.__init__/" title="autogoal" class="md-nav__link">
      autogoal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.__main__/" title="cli" class="md-nav__link">
      cli
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-2" type="checkbox" id="nav-10-2">
    
    <label class="md-nav__link" for="nav-10-2">
      Grammars
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-2">
        Grammars
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.grammar.__init__/" title="autogoal.grammar" class="md-nav__link">
      autogoal.grammar
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-3" type="checkbox" id="nav-10-3">
    
    <label class="md-nav__link" for="nav-10-3">
      Contrib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-10-3">
        Contrib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.contrib.__init__/" title="autogoal.contrib" class="md-nav__link">
      autogoal.contrib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10-3-2" type="checkbox" id="nav-10-3-2">
    
    <label class="md-nav__link" for="nav-10-3-2">
      scikit-learn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-10-3-2">
        scikit-learn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../autogoal.contrib.sklearn.__init__/" title="autogoal.contrib.sklearn" class="md-nav__link">
      autogoal.contrib.sklearn
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/autogoal/autogoal/edit/main/docs/api/autogoal.contrib.keras._crf.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <p>Copyright 2019 The TensorFlow Authors. All Rights Reserved.</p>
<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<div class="codehilite"><pre><span></span><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre></div>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
<h1 id="orginal-implementation-from-keras_contriblayerscrf">Orginal implementation from keras_contrib/layers/crf<a class="headerlink" href="#orginal-implementation-from-keras_contriblayerscrf" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""Implementing Conditional Random Field layer.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This code is taken verbatim from <a href="https://github.com/tensorflow/addons/pull/377">https://github.com/tensorflow/addons/pull/377</a>
since the CRF layer has not yet landed in tensorflow
TODO: Make sure to replace this when tensorflow merges this commit</p>
<p>Files:
<a href="https://github.com/tensorflow/addons/blob/e0b5e0f056d24b95546970acd4aedc3a5530d466/tensorflow_addons/layers/crf.py">https://github.com/tensorflow/addons/blob/e0b5e0f056d24b95546970acd4aedc3a5530d466/tensorflow_addons/layers/crf.py</a>
<a href="https://github.com/tensorflow/addons/blob/e0b5e0f056d24b95546970acd4aedc3a5530d466/tensorflow_addons/losses/crf.py">https://github.com/tensorflow/addons/blob/e0b5e0f056d24b95546970acd4aedc3a5530d466/tensorflow_addons/losses/crf.py</a></p>
</div>
<p><a name="ref:CRF"></a></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">typeguard</span> <span class="kn">import</span> <span class="n">typechecked</span>

<span class="kn">from</span> <span class="nn">tensorflow_addons.text.crf</span> <span class="kn">import</span> <span class="n">crf_decode</span><span class="p">,</span> <span class="n">crf_log_likelihood</span>
<span class="kn">from</span> <span class="nn">tensorflow_addons.utils</span> <span class="kn">import</span> <span class="n">types</span>


<span class="k">class</span> <span class="nc">CRF</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""Linear chain conditional random field (CRF).</p>
<p>Examples:</p>
<p>```python
from tensorflow_addons.layers import CRF
from tensorflow_addons.losses import crf_loss</p>
<p>model = Sequential()
model.add(Embedding(3001, 300, mask_zero=True)</p>
<p>crf = CRF(10)
model.add(crf)</p>
<p>model.compile('adam', loss=crf_loss)</p>
<p>model.fit(x, y)
```</p>
<p>Arguments:
units: Positive integer, dimensionality of the output space,
should equal to tag num.
chain_initializer: Initializer for the <code>chain_kernel</code> weights matrix,
used for the CRF chain energy.
(see <a href="../initializers.md">initializers</a>).
chain_regularizer: Regularizer function applied to
the <code>chain_kernel</code> weights matrix.
chain_constraint: Constraint function applied to
the <code>chain_kernel</code> weights matrix.
use_boundary: Boolean (default True), indicating if trainable
start-end chain energies should be added to model.
boundary_initializer: Initializer for the <code>left_boundary</code>,
'right_boundary' weights vectors,
used for the start/left and end/right boundary energy.
boundary_regularizer: Regularizer function applied to
the 'left_boundary', 'right_boundary' weight vectors.
boundary_constraint: Constraint function applied to
the <code>left_boundary</code>, <code>right_boundary</code> weights vectors.
use_kernel: Boolean (default True), indicating if apply
a fully connected layer before CRF op.
kernel_initializer: Initializer for the <code>kernel</code> weights matrix,
used for the linear transformation of the inputs.
kernel_regularizer: Regularizer function applied to
the <code>kernel</code> weights matrix.
kernel_constraint: Constraint function applied to
the <code>kernel</code> weights matrix.
use_bias: Boolean (default True), whether the layer uses a bias vector.
bias_initializer: Initializer for the bias vector.
bias_regularizer: Regularizer function applied to the bias vector.
bias_constraint: Constraint function applied to the bias vector.
activation: default value is 'linear', Activation function to use.</p>
<p>Input shape:
3D tensor with shape: <code>(batch_size, sequence_length, feature_size)</code>.</p>
<p>Output shape:
2D tensor (dtype: int32) with shape: <code>(batch_size, sequence_length)</code>.</p>
<p>Masking:
This layer supports masking
(2D tensor, shape: <code>(batch_size, sequence_length)</code>)
for input data with a variable number of timesteps.
This layer output same make tensor,
NOTICE this may cause issue when you
use some keras loss and metrics function which usually expect 1D mask.</p>
<p>Loss function:
Due to the TF 2.0 version support eager execution be default,
there is no way can implement CRF loss as independent loss function.
Thus, user should use loss method of this layer.
See Examples (above) for detailed usage.</p>
<p>References:
- <a href="https://en.wikipedia.org/wiki/Conditional_random_field">Conditional Random Field</a></p>
</div>
<div class="codehilite"><pre><span></span><code>    <span class="nd">@typechecked</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">chain_initializer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Initializer</span> <span class="o">=</span> <span class="s2">&quot;orthogonal&quot;</span><span class="p">,</span>
        <span class="n">chain_regularizer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Regularizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chain_constraint</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Constraint</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_boundary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">boundary_initializer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Initializer</span> <span class="o">=</span> <span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
        <span class="n">boundary_regularizer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Regularizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boundary_constraint</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Constraint</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_kernel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">kernel_initializer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Initializer</span> <span class="o">=</span> <span class="s2">&quot;glorot_uniform&quot;</span><span class="p">,</span>
        <span class="n">kernel_regularizer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Regularizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">kernel_constraint</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Constraint</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">bias_initializer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Initializer</span> <span class="o">=</span> <span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
        <span class="n">bias_regularizer</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Regularizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bias_constraint</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Constraint</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">activation</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Activation</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CRF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

<p>setup mask supporting flag, used by base class (the Layer)
because base class's init method will set it to False unconditionally
So this assigned must be executed after call base class's init method</p>
<div class="codehilite"><pre><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">supports_masking</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>  <span class="c1"># numbers of tags</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_boundary</span> <span class="o">=</span> <span class="n">use_boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span> <span class="o">=</span> <span class="n">use_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_kernel</span> <span class="o">=</span> <span class="n">use_kernel</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_initializer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kernel_initializer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_initializer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chain_initializer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_initializer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">boundary_initializer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_initializer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bias_initializer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kernel_regularizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chain_regularizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">boundary_regularizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bias_regularizer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_constraint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kernel_constraint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_constraint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chain_constraint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_constraint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">boundary_constraint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_constraint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bias_constraint</span><span class="p">)</span>
</code></pre></div>

<p>values will be assigned in method</p>
<div class="codehilite"><pre><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">input_spec</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>value remembered for loss/metrics function</p>
<div class="codehilite"><pre><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>global variable</p>
<div class="codehilite"><pre><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">chain_kernel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dense_layer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_boundary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_boundary</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
        <span class="n">input_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span>
</code></pre></div>

<p>see API docs of InputSpec for more detail</p>
<div class="codehilite"><pre><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">input_spec</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)]</span>
</code></pre></div>

<p>weights that work as transfer probability of each tags</p>
<div class="codehilite"><pre><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">chain_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;chain_kernel&quot;</span><span class="p">,</span>
            <span class="n">initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_initializer</span><span class="p">,</span>
            <span class="n">regularizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_regularizer</span><span class="p">,</span>
            <span class="n">constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_constraint</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>

<p>weight of <START> to tag probability and tag to <END> probability</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_boundary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;left_boundary&quot;</span><span class="p">,</span>
                <span class="n">initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_initializer</span><span class="p">,</span>
                <span class="n">regularizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_regularizer</span><span class="p">,</span>
                <span class="n">constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_constraint</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;right_boundary&quot;</span><span class="p">,</span>
                <span class="n">initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_initializer</span><span class="p">,</span>
                <span class="n">regularizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_regularizer</span><span class="p">,</span>
                <span class="n">constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_constraint</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_kernel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span>
                <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
                <span class="n">bias_initializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_initializer</span><span class="p">,</span>
                <span class="n">kernel_regularizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_regularizer</span><span class="p">,</span>
                <span class="n">bias_regularizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_regularizer</span><span class="p">,</span>
                <span class="n">kernel_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_constraint</span><span class="p">,</span>
                <span class="n">bias_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_constraint</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dense_layer</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CRF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</code></pre></div>

<p>mask: Tensor(shape=(batch_size, sequence_length), dtype=bool) or None</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input mask to CRF must have dim 2 if not None&quot;</span><span class="p">)</span>
</code></pre></div>

<p>left padding of mask is not supported, due the underline CRF function
detect it and report it to user</p>
<div class="codehilite"><pre><span></span><code>        <span class="n">first_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">left_boundary_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask_left_boundary</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">first_mask</span> <span class="o">=</span> <span class="n">left_boundary_mask</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<p>remember this value for later use</p>
<div class="codehilite"><pre><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">if</span> <span class="n">first_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">no_left_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_all</span><span class="p">(</span><span class="n">first_mask</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Currently, CRF layer do not support left padding&quot;</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">control_dependencies</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">debugging</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span>
                        <span class="n">no_left_padding</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">message</span><span class="o">=</span><span class="n">msg</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dense_layer</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dense_layer</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</code></pre></div>

<p>appending boundary probability info</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_boundary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_boundary_energy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_boundary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_boundary</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sequence_length</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

        <span class="n">decoded_sequence</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_viterbi_decoding</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">decoded_sequence</span>

    <span class="k">def</span> <span class="nf">_get_sequence_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""Currently underline CRF fucntion (provided by
tensorflow_addons.text.crf) do not support bi-direction masking (left
padding / right padding), it support right padding by tell it the
sequence length.</p>
<p>this function is compute the sequence length from input and
mask.</p>
</div>
<div class="codehilite"><pre><span></span><code>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sequence_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_to_sequence_length</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
</code></pre></div>

<p>make a mask tensor from input, then used to generate sequence_length</p>
<div class="codehilite"><pre><span></span><code>            <span class="n">input_energy_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
            <span class="n">raw_input_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">input_energy_shape</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">alt_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">raw_input_shape</span><span class="p">)</span>

            <span class="n">sequence_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_to_sequence_length</span><span class="p">(</span><span class="n">alt_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sequence_length</span>

    <span class="k">def</span> <span class="nf">mask_to_sequence_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""compute sequence length from mask."""
sequence_length = tf.cast(tf.reduce_sum(tf.cast(mask, tf.int8), 1), tf.int64)
return sequence_length</p>
<p>@staticmethod
def _compute_mask_right_boundary(mask):</p>
</div>
<p>shift mask to left by 1: 0011100 =&gt; 0111000</p>
<div class="codehilite"><pre><span></span><code>        <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">left_shifted_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">offset</span><span class="p">:],</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:</span><span class="n">offset</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
</code></pre></div>

<p>NOTE: below code is different from keras_contrib
Original code in keras_contrib:
end_mask = K.cast(
  K.greater(self.shift_left(mask), mask),
  K.floatx()
)
has a bug, confirmed
by the original keras_contrib maintainer
Luiz Felix (github: lzfelix),</p>
<p>0011100 &gt; 0111000 =&gt; 0000100</p>
<div class="codehilite"><pre><span></span><code>        <span class="n">right_boundary</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">left_shifted_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">right_boundary</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_mask_left_boundary</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"""input mask: 0011100, output left_boundary: 0010000."""</p>
<h1 id="shift-mask-to-right-by-1-0011100-0001110">shift mask to right by 1: 0011100 =&gt; 0001110<a class="headerlink" href="#shift-mask-to-right-by-1-0011100-0001110" title="Permanent link">&para;</a></h1>
<p>offset = 1
right_shifted_mask = tf.concat(
[tf.zeros_like(mask[:, :offset]), mask[:, :-offset]], axis=1
)</p>
<h1 id="0011100-0001110-0010000">0011100 &gt; 0001110 =&gt; 0010000<a class="headerlink" href="#0011100-0001110-0010000" title="Permanent link">&para;</a></h1>
<p>left_boundary = tf.greater(
tf.cast(mask, tf.int32), tf.cast(right_shifted_mask, tf.int32)
)</p>
<h1 id="left_boundary-tfgreatermask-right_shifted_mask">left_boundary = tf.greater(mask, right_shifted_mask)<a class="headerlink" href="#left_boundary-tfgreatermask-right_shifted_mask" title="Permanent link">&para;</a></h1>
<p>return left_boundary</p>
<p>def add_boundary_energy(self, potentials, mask, start, end):
def expand_scalar_to_3d(x):</p>
<h1 id="expand-tensor-from-shape-x-to-1-1-x">expand tensor from shape (x, ) to (1, 1, x)<a class="headerlink" href="#expand-tensor-from-shape-x-to-1-1-x" title="Permanent link">&para;</a></h1>
<p>return tf.reshape(x, (1, 1, -1))</p>
<p>start = expand_scalar_to_3d(start)
end = expand_scalar_to_3d(end)
if mask is None:
potentials = tf.concat(
[potentials[:, :1, :] + start, potentials[:, 1:, :]], axis=1
)
potentials = tf.concat(
[potentials[:, :-1, :], potentials[:, -1:, :] + end], axis=1
)
else:
mask = tf.keras.backend.expand_dims(tf.cast(mask, start.dtype), axis=-1)
start_mask = tf.cast(self._compute_mask_left_boundary(mask), start.dtype)</p>
<p>end_mask = tf.cast(self._compute_mask_right_boundary(mask), end.dtype)
potentials = potentials + start_mask * start
potentials = potentials + end_mask * end
return potentials</p>
<p>def get_viterbi_decoding(self, potentials, sequence_length):</p>
<h1 id="decode_tags-a-batch_size-max_seq_len-matrix-with-dtype-tfint32">decode_tags: A [batch_size, max_seq_len] matrix, with dtype <code>tf.int32</code><a class="headerlink" href="#decode_tags-a-batch_size-max_seq_len-matrix-with-dtype-tfint32" title="Permanent link">&para;</a></h1>
<p>decode_tags, best_score = crf_decode(
potentials, self.chain_kernel, sequence_length
)</p>
<p>return decode_tags, best_score</p>
<p>def get_config(self):</p>
<h1 id="used-for-loading-model-from-disk">used for loading model from disk<a class="headerlink" href="#used-for-loading-model-from-disk" title="Permanent link">&para;</a></h1>
<p>config = {
"units": self.units,
"use_boundary": self.use_boundary,
"use_bias": self.use_bias,
"use_kernel": self.use_kernel,
"kernel_initializer": tf.keras.initializers.serialize(
self.kernel_initializer
),
"chain_initializer": tf.keras.initializers.serialize(
self.chain_initializer
),
"boundary_initializer": tf.keras.initializers.serialize(
self.boundary_initializer
),
"bias_initializer": tf.keras.initializers.serialize(self.bias_initializer),
"activation": tf.keras.activations.serialize(self.activation),
"kernel_regularizer": tf.keras.regularizers.serialize(
self.kernel_regularizer
),
"chain_regularizer": tf.keras.regularizers.serialize(
self.chain_regularizer
),
"boundary_regularizer": tf.keras.regularizers.serialize(
self.boundary_regularizer
),
"bias_regularizer": tf.keras.regularizers.serialize(self.bias_regularizer),
"kernel_constraint": tf.keras.constraints.serialize(self.kernel_constraint),
"chain_constraint": tf.keras.constraints.serialize(self.chain_constraint),
"boundary_constraint": tf.keras.constraints.serialize(
self.boundary_constraint
),
"bias_constraint": tf.keras.constraints.serialize(self.bias_constraint),
}
base_config = super(CRF, self).get_config()
return dict(list(base_config.items()) + list(config.items()))</p>
<p>def compute_output_shape(self, input_shape):
output_shape = input_shape[:2]
return output_shape</p>
<p>def compute_mask(self, input_, mask=None):</p>
</div>
<div class="codehilite"><pre><span></span><code>        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">get_negative_log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">log_likelihood</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">crf_log_likelihood</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">potentials</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_kernel</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">log_likelihood</span>

    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</code></pre></div>

<p>we don't use y_pred, but caller pass it anyway, ignore it</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_negative_log_likelihood</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="n">judge</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">floatx</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">judge</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">floatx</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">judge</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CRF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

<p>A hack that add _keras_history to EagerTensor, make it more like normal Tensor</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="s2">&quot;_keras_history&quot;</span><span class="p">):</span>
                <span class="n">tensor</span><span class="o">.</span><span class="n">_keras_history</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outputs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_compute_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</code></pre></div>

<p>fixed output dtype from underline CRF functions</p>
<p><a name="ref:ConditionalRandomFieldLoss"></a></p>
<div class="codehilite"><pre><span></span><code>        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>


<span class="k">class</span> <span class="nc">ConditionalRandomFieldLoss</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;crf_loss&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">crf_layer</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">_keras_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<p>check if last layer is CRF</p>
<div class="codehilite"><pre><span></span><code>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crf_layer</span><span class="p">,</span> <span class="n">CRF</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Last layer must be CRF for use </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">loss_vector</span> <span class="o">=</span> <span class="n">crf_layer</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_vector</span><span class="p">)</span>


<span class="n">crf_loss</span> <span class="o">=</span> <span class="n">ConditionalRandomFieldLoss</span><span class="p">()</span>
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../.."}})</script>
      
    
  </body>
</html>